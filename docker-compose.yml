# =============================================================================
# Aynux Docker Compose - Development Environment
# =============================================================================
# Usage:
#   docker compose up -d              # Start all services
#   docker compose up -d --build      # Rebuild and start
#   docker compose logs -f app        # Follow app logs
#   docker compose down               # Stop all services
#   docker compose down -v            # Stop and remove volumes
#
# External Services (run separately):
#   - vLLM: http://localhost:8090/v1 (LLM inference)
#   - TEI:  http://localhost:7997 (embeddings)
# =============================================================================

name: aynux

services:
  # ---------------------------------------------------------------------------
  # PostgreSQL with pgvector extension
  # Image includes pgvector pre-installed
  # ---------------------------------------------------------------------------
  postgres:
    image: pgvector/pgvector:pg18
    container_name: aynux-postgres
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${DB_USER:-aynux}
      POSTGRES_PASSWORD: ${DB_PASSWORD:-aynux_dev}
      POSTGRES_DB: ${DB_NAME:-aynux}
      # Performance tuning for development
      POSTGRES_INITDB_ARGS: "--encoding=UTF8 --locale=C"
    ports:
      - "${DB_PORT:-5432}:5432"
    volumes:
      - postgres_data:/var/lib/postgresql
      - ./scripts/init-db.sql:/docker-entrypoint-initdb.d/01-init.sql:ro
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DB_USER:-aynux} -d ${DB_NAME:-aynux}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    networks:
      - aynux-network

  # ---------------------------------------------------------------------------
  # Redis for caching and session storage
  # ---------------------------------------------------------------------------
  redis:
    image: redis:7-alpine
    container_name: aynux-redis
    restart: unless-stopped
    command: >
      redis-server
      --appendonly yes
      --maxmemory 256mb
      --maxmemory-policy allkeys-lru
      --save 60 1000
      --requirepass ${REDIS_PASSWORD:-Excelenci@5948}
    ports:
      - "${REDIS_PORT:-6379}:6379"
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD-SHELL", "REDISCLI_AUTH=${REDIS_PASSWORD:-Excelenci@5948} redis-cli ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - aynux-network

  # ---------------------------------------------------------------------------
  # vLLM + TEI Services (External - not managed by Docker Compose)
  # ---------------------------------------------------------------------------
  # vLLM and TEI run on external servers for GPU acceleration.
  #
  # Development (localhost):
  #   vLLM: http://localhost:8090/v1
  #   TEI:  http://localhost:7997
  #
  # Production (192.168.0.140):
  #   vLLM: http://192.168.0.140:8090/v1
  #   TEI:  http://192.168.0.140:7997
  #
  # To start vLLM locally:
  #   docker run --gpus all -p 8090:8000 \
  #     vllm/vllm-openai:latest \
  #     --model Qwen/Qwen2.5-3B-Instruct-AWQ \
  #     --served-model-name qwen-3b
  #
  # To start TEI locally:
  #   docker run --gpus all -p 7997:80 \
  #     ghcr.io/huggingface/text-embeddings-inference:turing-1.5 \
  #     --model-id BAAI/bge-m3
  # ---------------------------------------------------------------------------

  # ---------------------------------------------------------------------------
  # FastAPI Application (Development with hot-reload)
  # ---------------------------------------------------------------------------
  # NOTE: If docker compose build fails with credential errors, build manually:
  #   docker build --target development -t aynux-app:dev .
  # ---------------------------------------------------------------------------
  app:
    image: aynux-app:dev
    pull_policy: never  # Use local image, don't try to pull from registry
    build:
      context: .
      dockerfile: Dockerfile
      target: development
    restart: unless-stopped
    ports:
      - "8080:8080"
    volumes:
      # Mount source code for hot-reload
      - ./app:/app/app:cached
      # Mount tests for development
      - ./tests:/app/tests:cached
      # Don't mount .venv - use container's virtual environment
    environment:
      # Database Configuration
      - DB_HOST=postgres
      - DB_PORT=5432
      - DB_NAME=${DB_NAME:-aynux}
      - DB_USER=${DB_USER:-aynux}
      - DB_PASSWORD=${DB_PASSWORD:-aynux_dev}
      - DB_POOL_SIZE=5
      - DB_MAX_OVERFLOW=10
      - DB_POOL_RECYCLE=3600
      - DB_POOL_TIMEOUT=30
      - DB_ECHO=false
      # Redis Configuration
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_DB=0
      - REDIS_PASSWORD=${REDIS_PASSWORD}
      # vLLM Configuration (single model)
      - VLLM_BASE_URL=${VLLM_BASE_URL:-http://host.docker.internal:8090/v1}
      - VLLM_API_KEY=${VLLM_API_KEY:-EMPTY}
      - VLLM_MODEL=${VLLM_MODEL:-qwen-3b}
      - VLLM_REQUEST_TIMEOUT=${VLLM_REQUEST_TIMEOUT:-120}
      - VLLM_MAX_RETRIES=${VLLM_MAX_RETRIES:-3}
      # TEI Embeddings Configuration
      - TEI_BASE_URL=${TEI_BASE_URL:-http://host.docker.internal:7997}
      - TEI_MODEL=${TEI_MODEL:-BAAI/bge-m3}
      - TEI_EMBEDDING_DIMENSION=${TEI_EMBEDDING_DIMENSION:-1024}
      - TEI_REQUEST_TIMEOUT=${TEI_REQUEST_TIMEOUT:-30}
      # pgvector Configuration
      - PGVECTOR_SIMILARITY_THRESHOLD=0.7
      # Application Settings
      - ENVIRONMENT=development
      - DEBUG=true
      - TESTING=false
      # API Configuration
      - API_V1_STR=/api/v1
      - PROJECT_NAME=Aynux WhatsApp Bot
      # Chattigo Integration (WhatsApp via ISV)
      # Note: Credentials are stored in database (chattigo_credentials table)
      # Configure via Admin API: POST /api/v1/admin/chattigo-credentials
      - CHATTIGO_ENABLED=${CHATTIGO_ENABLED:-true}
      - CHATTIGO_BASE_URL=${CHATTIGO_BASE_URL:-https://channels.chattigo.com/bsp-cloud-chattigo-isv}
      # DUX Sync - controlled via .env file only (not host environment)
      # Set DUX_SYNC_ENABLED=true in .env to enable
      # LangSmith (optional - for tracing)
      - LANGSMITH_TRACING_ENABLED=${LANGSMITH_TRACING_ENABLED:-false}
      - LANGSMITH_API_KEY=${LANGSMITH_API_KEY:-}
      - LANGSMITH_PROJECT=${LANGSMITH_PROJECT:-aynux-dev}
      # Skip DB init since we want to control it
      - SKIP_DB_INIT=false
    env_file:
      - path: .env
        required: false
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    networks:
      - aynux-network

  # ---------------------------------------------------------------------------
  # Frontend - Nginx serving Vue.js SPA (Development)
  # ---------------------------------------------------------------------------
  frontend:
    build:
      context: ../vuejs
      dockerfile: Dockerfile
    container_name: aynux-frontend
    restart: unless-stopped
    ports:
      - "3002:80"
    depends_on:
      app:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:80/health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s
    networks:
      - aynux-network

# =============================================================================
# Networks
# =============================================================================
networks:
  aynux-network:
    driver: bridge
    name: aynux-network

# =============================================================================
# Volumes (persistent data)
# =============================================================================
volumes:
  postgres_data:
    name: aynux-postgres-data
  redis_data:
    name: aynux-redis-data
